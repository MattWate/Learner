<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Genie - Learner Hub</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M88.6 70.3c-2.5-1.5-5.3-2.3-8.2-2.3h-52c-1.7 0-3 1.3-3 3s1.3 3 3 3h52c1.7 0 3.3-.6 4.6-1.8 2.2-2 1.8-5.5-.4-7.2zM27 60.1h56.7c1.6 0 3-1.3 3-3s-1.3-3-3-3H27c-1.7 0-3 1.3-3 3s1.4 3 3 3zM25.4 49.1c-1.4 0-2.6 1.1-2.6 2.5s1.2 2.5 2.6 2.5h52c1.7 0 3-1.3 3-3s-1.3-3-3-3h-52c-.6 0-1.1.2-1.5.5-1-.7-2.3-.6-3.3.4-1.2 1.2-1.2 3.2 0 4.4 1 1 2.3 1.3 3.5.7.1-.1.2-.2.3-.3z' fill='%236366F1'/><path d='M75.1 23.3C72.3 14 62.5 8.3 51.5 10.1c-10.9 1.8-19.1 11.1-17.3 22 1.4 8.7 8.3 14.8 16.7 15.6 0 0 .1.1.2.1h.3c.1 0 .3 0 .4-.1.4 0 .9-.1 1.3-.2 1-.2 1.9-.5 2.8-.8 8.9-3.2 14.6-11.7 12.8-21.2zm-2.1 1.6c1.3 6.9-2.9 13.5-9.8 15.8-1.2.4-2.4.7-3.6.8-.5.1-1 .1-1.5.1h-.2c-.1 0-.2 0-.3.1-6.1.5-11.4-3-12.8-9.1-1.3-6.9 2.9-13.5 9.8-15.8 6.9-2.4 13.9.7 16.3 7.6.3.8.5 1.7.6 2.6z' fill='%23F59E0B'/></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-to-docx@1.8.0/dist/html-to-docx.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom, rgb(238 242 255), #f8fafc);
        }
        .prose { max-width: 65ch; }
        .prose-sm { font-size: 0.875rem; line-height: 1.5; }
        @media print {
            /* Print styles are kept for now, but are unused */
        }
        /* Custom class for the new logo */
        .genie-logo {
            width: 2.25rem;
            height: 2.25rem;
            stroke-width: 2;
        }
        /* Styles for quiz feedback */
        .quiz-question-wrapper.correct {
            border-left-color: #22c55e; /* green-500 */
            background-color: #f0fdf4; /* green-50 */
        }
        .quiz-question-wrapper.incorrect {
            border-left-color: #ef4444; /* red-500 */
            background-color: #fef2f2; /* red-50 */
        }
        .quiz-feedback {
            display: none;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.75rem;
        }
        .quiz-question-wrapper.correct .quiz-feedback.correct {
            display: block;
            color: #166534; /* green-800 */
        }
        .quiz-question-wrapper.incorrect .quiz-feedback.incorrect {
            display: block;
            color: #991b1b; /* red-800 */
        }

    </style>
</head>
<body>
    <svg width="0" height="0" class="absolute">
        <defs>
            <symbol id="genie-logo" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2a4 4 0 0 0-4 4v0a4 4 0 0 0 4 4v0a4 4 0 0 0 4-4v0a4 4 0 0 0-4-4Z" class="text-amber-400" fill="currentColor" stroke="none" />
                <path d="M12 10v2" class="text-amber-500" />
                <path d="m4.9 4.9 1.4 1.4" class="text-amber-500" />
                <path d="m17.7 7.7 1.4-1.4" class="text-amber-500" />
                <path d="M2 12h2" class="text-amber-500" />
                <path d="M20 12h2" class="text-amber-500" />
                <path d="M5 22h14" class="text-indigo-600" />
                <path d="M5 18h14" class="text-indigo-600" />
                <path d="M8.5 18c0-2.3.9-4.4 2.5-6 1.6-1.6 3.7-2.5 6-2.5 1.7 0 3.3.3 4.8.9" class="text-indigo-600" />
            </symbol>
        </defs>
    </svg>

    <div class="min-h-screen">
        <header class="md:hidden bg-white p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center">
                <svg class="genie-logo"><use href="#genie-logo"></use></svg>
                <h1 class="ml-2 text-xl font-bold text-gray-800">Learning Genie</h1>
            </div>
            <button id="menu-toggle-btn" class="p-2">
                <i data-lucide="menu" class="h-6 w-6"></i>
            </button>
        </header>

        <div class="md:flex">
            <aside id="sidebar" class="hidden md:flex w-full md:w-64 bg-white p-4 md:h-screen md:sticky top-0 border-r border-gray-200 print:hidden flex-col fixed inset-0 z-50 md:relative">
                <div class="hidden md:flex items-center mb-8">
                    <svg class="genie-logo"><use href="#genie-logo"></use></svg>
                    <h1 class="ml-2 text-xl font-bold text-gray-800">Learning Genie</h1>
                </div>
                <nav id="sidebar-nav" class="space-y-2"></nav>
            </aside>

            <main id="main-content" class="flex-1 p-4 md:p-8"></main>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        const state = {
            activeTab: 'home',
            uploadedImageBase64: null,
            currentTest: null // To store test data for grading
        };
        const mainContent = document.getElementById('main-content');
        const sidebarNav = document.getElementById('sidebar-nav');

        // --- TEMPLATES / VIEWS ---
        // (homePageTemplate, parentHubTemplate, homeworkHelperTemplate remain the same)
        const homePageTemplate = `
            <div class="max-w-4xl mx-auto text-center">
                 <div class="bg-white p-8 md:p-12 rounded-xl shadow-xl border-t-4 border-indigo-500">
                    <i data-lucide="sparkles" class="mx-auto h-16 w-16 text-amber-400"></i>
                    <h1 class="mt-4 text-4xl md:text-5xl font-bold text-gray-800">Welcome to Your Learner Hub</h1>
                    <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">Your AI-powered assistant for learning. Get help with homework, revise topics, and practice for tests.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
                    <div data-nav-link="homeworkHelper" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-rose-400">
                        <i data-lucide="life-buoy" class="h-12 w-12 text-rose-500 mb-4 mx-auto"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Homework Helper</h2>
                        <p class="mt-2 text-gray-600">Upload a photo of a worksheet to get hints and explanations.</p>
                    </div>
                    <div data-nav-link="learningHub" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-indigo-500">
                        <i data-lucide="book-marked" class="h-12 w-12 text-indigo-600 mb-4 mx-auto"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Learning Hub</h2>
                        <p class="mt-2 text-gray-600">Enter a topic to get revision notes and a practice test.</p>
                    </div>
                    <div data-nav-link="explainSimply" class="group bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 cursor-pointer border-t-4 border-amber-400 md:col-span-2">
                        <i data-lucide="baby" class="h-12 w-12 text-amber-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Explain It Simply</h2>
                        <p class="mt-2 text-gray-600">Get a simple, easy-to-understand explanation of any topic.</p>
                    </div>
                </div>
            </div>`;
        
        const parentHubTemplate = homePageTemplate; 

        const homeworkHelperTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-indigo-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Homework Helper</h2>
                    <p class="text-gray-500 mb-8">Upload a photo of your worksheet to get started.</p>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Upload Worksheet Photo</label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <i data-lucide="camera" class="mx-auto h-12 w-12 text-gray-400"></i>
                                <div class="flex text-sm text-gray-600">
                                    <label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500"><span>Upload a file</span><input id="image-upload" type="file" class="sr-only" accept="image/*"></label>
                                </div>
                                <p class="text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
                            </div>
                        </div>
                        <div id="image-preview-wrapper" class="hidden mt-4">
                            <img id="image-preview" class="rounded-lg max-h-64 mx-auto" />
                            <button id="remove-image-btn" class="mt-2 mx-auto flex items-center text-sm text-red-600 hover:text-red-800"><i data-lucide="x" class="h-4 w-4 mr-1"></i>Remove image</button>
                        </div>
                    </div>
                    <button id="generate-homework-help-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center disabled:bg-indigo-300"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Get Help</button>
                    <div id="hh-error" class="text-red-500 text-sm mt-2 hidden"></div>
                </div>
                <div id="hh-output" class="mt-8"></div>
            </div>`;
        
        const learningHubTemplate = `
             <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-indigo-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Learning Hub</h2>
                    <p class="text-gray-500 mb-8">Describe a topic or upload a photo to get revision notes and a practice test.</p>
                     <div class="space-y-6">
                        <div>
                            <label for="learn-topic" class="block text-sm font-medium text-gray-700 mb-1">What do you want to learn about?</label>
                            <textarea id="learn-topic" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., The planets in our solar system"></textarea>
                        </div>
                        <div class="text-center text-sm text-gray-500">OR</div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload a Photo (optional)</label>
                            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                                <div class="space-y-1 text-center">
                                    <i data-lucide="camera" class="mx-auto h-12 w-12 text-gray-400"></i>
                                    <div class="flex text-sm text-gray-600">
                                        <label for="image-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500"><span>Upload a file</span><input id="image-upload" type="file" class="sr-only" accept="image/*"></label>
                                    </div>
                                </div>
                            </div>
                            <div id="image-preview-wrapper" class="hidden mt-4">
                                <img id="image-preview" class="rounded-lg max-h-64 mx-auto" />
                                <button id="remove-image-btn" class="mt-2 mx-auto flex items-center text-sm text-red-600 hover:text-red-800"><i data-lucide="x" class="h-4 w-4 mr-1"></i>Remove image</button>
                            </div>
                        </div>
                    </div>
                    <button id="generate-learning-help-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center disabled:bg-indigo-300"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Help Me Learn</button>
                    <div id="lh-error" class="text-red-500 text-sm mt-2 hidden"></div>
                </div>
                <div id="lh-output" class="mt-8"></div>
            </div>`;
        
        const explainSimplyTemplate = `
            <div class="max-w-4xl mx-auto">
                <div class="bg-white p-8 rounded-xl shadow-xl border-t-4 border-indigo-500 print:hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Explain It Simply</h2>
                    <p class="text-gray-500 mb-8">Enter a complex topic or question to get a simple explanation.</p>
                    <div>
                        <label for="explain-topic" class="block text-sm font-medium text-gray-700 mb-1">What do you want explained?</label>
                        <textarea id="explain-topic" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., What is photosynthesis? or Explain black holes"></textarea>
                    </div>
                    <button id="generate-explanation-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 flex items-center justify-center disabled:bg-indigo-300"><i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Explain</button>
                    <div id="es-error" class="text-red-500 text-sm mt-2 hidden"></div>
                </div>
                <div id="es-output" class="mt-8"></div>
            </div>`;

        // --- RENDER & NAVIGATION ---
        function render() {
            const templates = {
                home: homePageTemplate,
                parentHub: parentHubTemplate,
                homeworkHelper: homeworkHelperTemplate,
                learningHub: learningHubTemplate,
                explainSimply: explainSimplyTemplate,
            };
            mainContent.innerHTML = templates[state.activeTab] || homePageTemplate;
            updateSidebar();
            lucide.createIcons();
        }

        function updateSidebar() {
            const homeNav = `<button data-nav-link="home" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg"><i data-lucide="home" class="h-5 w-5"></i><span class="ml-3">Home</span></button>`;
            
            const parentNav = `
                <button data-nav-link="homeworkHelper" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg"><i data-lucide="life-buoy" class="h-5 w-5"></i><span class="ml-3">Homework Helper</span></button>
                <button data-nav-link="learningHub" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg"><i data-lucide="book-marked" class="h-5 w-5"></i><span class="ml-3">Learning Hub</span></button>
                <button data-nav-link="explainSimply" class="nav-link flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg"><i data-lucide="baby" class="h-5 w-5"></i><span class="ml-3">Explain It Simply</span></button>
            `;
            
            sidebarNav.innerHTML = homeNav + parentNav;

            // Highlight active link
            document.querySelectorAll('.nav-link').forEach(link => {
                const linkTab = link.dataset.navLink;
                const isActive = (linkTab === state.activeTab);

                if (isActive) {
                    link.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                    link.classList.remove('text-gray-600', 'hover:bg-gray-100');
                } else {
                    link.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
                    link.classList.add('text-gray-600', 'hover:bg-gray-100');
                }
            });
        }
        
        // --- EVENT HANDLING (using delegation) ---
        document.addEventListener('click', (e) => {
            const navLink = e.target.closest('[data-nav-link]');
            if (navLink) { 
                state.activeTab = navLink.dataset.navLink;
                state.uploadedImageBase64 = null;
                state.currentTest = null; // Clear test on navigation
                render(); 
                return; 
            }
            
            if (e.target.closest('#generate-homework-help-btn')) handleGenerateHomeworkHelp();
            if (e.target.closest('#generate-learning-help-btn')) handleGenerateLearningHelp();
            if (e.target.closest('#generate-explanation-btn')) handleGenerateExplanation();
            if (e.target.closest('#remove-image-btn')) handleRemoveImage();
        });

        mainContent.addEventListener('change', (e) => {
            if (e.target.id === 'image-upload') handleImageChange(e);
        });
        
        // MODIFIED: Event listener for quiz submission is now async
        mainContent.addEventListener('submit', async (e) => {
            if (e.target.id === 'quiz-form') {
                e.preventDefault();
                await handleQuizSubmit(e.target); // Await the async grading
            }
        });

        // --- API & BUSINESS LOGIC ---
        
        async function fetchWithRetry(prompt, isJson, retries = 1, requestType = 'text', imageData = null) {
            //
            try {
                const response = await fetch('/.netlify/functions/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, isJson, requestType, imageData })
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                }
                
                const result = await response.json();

                if (requestType === 'image') {
                    if (!result.predictions?.[0]?.bytesBase64Encoded) throw new Error("Image generation failed.");
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                }
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error("The AI returned an empty response.");
                return text;
            } catch (error) {
                if (retries > 0) {
                    console.warn("Request failed, retrying...", error);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return fetchWithRetry(prompt, isJson, retries - 1, requestType, imageData);
                }
                throw error;
            }
        }
        
        // --- PARENT/LEARNER TOOL HANDLERS ---
        async function handleGenerateHomeworkHelp() {
            // (This function remains unchanged)
            const errorEl = document.getElementById('hh-error');
            const outputEl = document.getElementById('hh-output');
            const button = document.getElementById('generate-homework-help-btn');

            errorEl.classList.add('hidden');
            if (!state.uploadedImageBase64) {
                errorEl.textContent = 'Please upload a photo of your worksheet.';
                errorEl.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Analyzing...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Analyzing your worksheet...</p></div>`;
            
            const prompt = `You are a helpful and safe AI assistant for students. Your primary goal is to explain educational topics in an age-appropriate and safe manner. Analyze the uploaded worksheet image. Provide a JSON object with three keys: "breakdown", "hints", and "answers". "breakdown" should be a simple, bullet-pointed summary of the instructions. "hints" should be an array of gentle hints for each question to guide the student. "answers" should be an array with the final answers to check against.`;

            try {
                const jsonText = await fetchWithRetry(prompt, true, 1, 'text', state.uploadedImageBase64);
                const result = JSON.parse(jsonText);

                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg space-y-6">
                        ${createSectionHTML('list-checks', 'blue', "Let's Break It Down", result.breakdown)}
                        ${createSectionHTML('lightbulb', 'yellow', 'Helpful Hints', result.hints)}
                        ${createSectionHTML('key-round', 'green', 'Check Your Work', result.answers)}
                    </div>
                `;
                lucide.createIcons();
            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Get Help`;
                lucide.createIcons();
            }
        }

        async function handleGenerateLearningHelp() {
            // (This function remains unchanged from the previous step)
            const topic = document.getElementById('learn-topic').value;
            const errorEl = document.getElementById('lh-error');
            const outputEl = document.getElementById('lh-output');
            const button = document.getElementById('generate-learning-help-btn');

            errorEl.classList.add('hidden');
            if (!topic && !state.uploadedImageBase64) {
                errorEl.textContent = 'Please enter a topic or upload a photo.';
                errorEl.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Generating...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Building your learning guide...</p></div>`;
            state.currentTest = null; 

            const prompt = `You are a helpful and safe AI assistant for students. Your primary goal is to explain educational topics in an age-appropriate and safe manner. Analyze the following topic or image.
Provide a JSON object with three keys: "learning_objectives", "revision_notes", and "practice_test".
- "learning_objectives": A bulleted list of key things a student should know.
- "revision_notes": Detailed and comprehensive notes, broken into key sections.
- "practice_test": An array of 5-7 question objects. Each object must have three keys:
    1. "question": The string of the question text.
    2. "type": A string, either "MCQ" (Multiple Choice), "TrueFalse", or "ShortAnswer".
    3. "options": An array of strings for "MCQ" and "TrueFalse" types. Leave empty [] for "ShortAnswer".
    4. "correct_answer": The string of the correct answer. For "MCQ" and "TrueFalse", this must exactly match one of the strings in the "options" array. For "ShortAnswer", this is the expected answer.
The topic is: ${topic}`;

            try {
                const jsonText = await fetchWithRetry(prompt, true, 1, 'text', state.uploadedImageBase64);
                const result = JSON.parse(jsonText);
                
                state.currentTest = result.practice_test || [];
                const quizHtml = renderPracticeTest(state.currentTest);

                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg space-y-6">
                        ${createSectionHTML('check-circle', 'green', "Key Learning Objectives", result.learning_objectives)}
                        ${createSectionHTML('book-open', 'indigo', "Revision Notes", result.revision_notes)}
                        
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                             <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="file-check-2" class="text-blue-500"></i><span class="ml-2">Practice Test</span></h3>
                             <p class="text-sm text-gray-600 mb-6">Test your knowledge! Check your answers at the end.</p>
                             <div id="quiz-results" class="mb-6"></div>
                             ${quizHtml}
                        </div>
                    </div>
                `;
                lucide.createIcons();
            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Help Me Learn`;
                lucide.createIcons();
            }
        }

        async function handleGenerateExplanation() {
            // (This function remains unchanged)
            const topic = document.getElementById('explain-topic').value;
            const errorEl = document.getElementById('es-error');
            const outputEl = document.getElementById('es-output');
            const button = document.getElementById('generate-explanation-btn');

            errorEl.classList.add('hidden');
            if (!topic) {
                errorEl.textContent = 'Please enter a topic or question.';
                errorEl.classList.remove('hidden');
                return;
            }

            button.disabled = true;
            button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Explaining...`;
            outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Thinking of a simple explanation...</p></div>`;

            const prompt = `You are a helpful and safe AI assistant for students. Your primary goal is to explain educational topics in an age-appropriate and safe manner. Explain the following topic or question in a simple, easy-to-understand way, as if you were explaining it to a child. Use analogies and simple language. Topic: "${topic}"`;

            try {
                const text = await fetchWithRetry(prompt, false);
                outputEl.innerHTML = `
                    <div class="bg-gray-50/50 p-6 rounded-lg">
                        ${createSectionHTML('baby', 'amber', 'Here is a simple explanation', text)}
                    </div>
                `;
                lucide.createIcons();
            } catch (e) {
                errorEl.textContent = `An error occurred: ${e.message}`;
                errorEl.classList.remove('hidden');
                outputEl.innerHTML = '';
            } finally {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Explain`;
                lucide.createIcons();
            }
        }
        
        // --- FILE & IMAGE HANDLERS ---
        
        function handleImageChange(e) {
            // (This function remains unchanged)
            const file = e.target.files[0];
            if (!file) return;
            const previewWrapper = document.getElementById('image-preview-wrapper');
            const previewImg = document.getElementById('image-preview');
            const reader = new FileReader();
            reader.onload = (event) => {
                state.uploadedImageBase64 = event.target.result.split(',')[1];
                previewImg.src = event.target.result;
                previewWrapper.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function handleRemoveImage() {
            // (This function remains unchanged)
            state.uploadedImageBase64 = null;
            document.getElementById('image-preview-wrapper').classList.add('hidden');
            document.getElementById('image-upload').value = null;
        }

        // --- UTILITY FUNCTIONS ---
        function createSectionHTML(icon, color, title, content) {
            // (This function remains unchanged)
            const cleanMarkdown = (text) => {
                return String(text)
                    .replace(/\*\*\*(.*?)\*\*\*/g, '<hr class="my-4 border-gray-200"><strong><em>$1</em></strong><hr class="my-4 border-gray-200">')
                    .replace(/\*\*/g, '')
                    .replace(/\*/g, '')
                    .replace(/## /g, '<h3 class="text-md font-semibold mt-4">')
                    .replace(/\n/g, '<br>');
            };

            let textContent = 'No content provided.';
            if (typeof content === 'string') {
                textContent = cleanMarkdown(content);
            } else if (Array.isArray(content)) {
                textContent = `<ol class="list-decimal list-inside">${content.map(item => `<li>${cleanMarkdown(item)}</li>`).join('')}</ol>`;
            } else if (typeof content === 'object' && content !== null) {
                const formatObject = (obj) => {
                    return `<ul class="list-disc list-inside ml-4">${Object.entries(obj).map(([key, value]) => `<li><strong>${key}:</strong> ${formatContent(value)}</li>`).join('')}</ul>`;
                };
                const formatArray = (arr) => {
                    return `<ol class="list-decimal list-inside">${arr.map(item => `<li>${formatContent(item)}</li>`).join('')}</ol>`;
                };
                const formatContent = (item) => {
                    if (typeof item === 'string') return cleanMarkdown(item);
                    if (Array.isArray(item)) return formatArray(item);
                    if (typeof item === 'object' && item !== null) return formatObject(item);
                    return cleanMarkdown(String(item));
                };
                textContent = formatContent(content);
            } else if (content) {
                textContent = cleanMarkdown(String(content));
            }
            return `<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 break-inside-avoid"><h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="${icon}" class="text-${color}-500"></i><span class="ml-2">${title}</span></h3><div class="prose prose-sm max-w-none text-gray-600">${textContent}</div></div>`;
        }
        
        function renderPracticeTest(testData) {
            // (This function remains unchanged)
            if (!testData || testData.length === 0) {
                return "<p class='text-sm text-gray-500'>No practice test could be generated for this topic.</p>";
            }

            let html = '<form id="quiz-form" class="space-y-6">';
            
            testData.forEach((question, index) => {
                html += `<div id="question-block-${index}" class="quiz-question-wrapper border-l-4 border-gray-200 p-4 rounded-r-lg">`;
                html += `<p class="font-semibold text-gray-800 mb-3">${index + 1}. ${question.question}</p>`;
                html += `<div class="space-y-2">`;

                if (question.type === 'MCQ' || question.type === 'TrueFalse') {
                    question.options.forEach((option) => {
                        html += `
                            <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="question_${index}" value="${option}" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <span class="ml-3 text-sm text-gray-700">${option}</span>
                            </label>
                        `;
                    });
                } else if (question.type === 'ShortAnswer') {
                    html += `
                        <label>
                            <span class="text-sm font-medium text-gray-700 sr-only">Your Answer:</span>
                            <input type="text" name="question_${index}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type your answer here...">
                        </label>
                    `;
                }
                html += `</div>`;
                html += `
                    <div class="quiz-feedback correct">
                        <i data-lucide="check-circle" class="inline-block h-4 w-4 mr-1"></i>Correct!
                    </div>
                    <div class="quiz-feedback incorrect">
                        <i data-lucide="x-circle" class="inline-block h-4 w-4 mr-1"></i>Incorrect. The correct answer is: <strong>${question.correct_answer}</strong>
                    </div>
                `;
                html += `</div>`;
            });

            html += `<button id="submit-quiz-btn" type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center disabled:bg-green-300"><i data-lucide="check" class="w-5 h-5 mr-2"></i>Check My Answers</button>`;
            html += '</form>';
            return html;
        }

        // MODIFIED: Function is now async and uses AI for grading
        async function handleQuizSubmit(formElement) {
            if (!state.currentTest) return;

            const formData = new FormData(formElement);
            const submitButton = formElement.querySelector('button[type="submit"]');

            // Disable button and show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Grading...`;
            
            // Disable all inputs
            formElement.querySelectorAll('input').forEach(input => input.disabled = true);
            
            // Build an array of promises for grading each question
            const gradingPromises = state.currentTest.map((question, index) => {
                const userAnswer = formData.get(`question_${index}`);
                const correctAnswer = question.correct_answer;

                if (!userAnswer) {
                    return Promise.resolve(false); // No answer is incorrect
                }

                if (question.type === 'MCQ' || question.type === 'TrueFalse') {
                    // Simple boolean check for multiple choice
                    return Promise.resolve(userAnswer === correctAnswer);
                } 
                
                if (question.type === 'ShortAnswer') {
                    // Check for a simple, exact match first to save an API call
                    if (userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase()) {
                        return Promise.resolve(true);
                    }
                    // If no exact match, ask the AI to grade it
                    const prompt = `You are an AI grader. A student was asked the following question: "${question.question}". The model answer is: "${correctAnswer}". The student provided this answer: "${userAnswer}". Is the student's answer substantially correct? Your response must be a single word: "Correct" or "Incorrect".`;
                    return fetchWithRetry(prompt, false); // Returns a string "Correct" or "Incorrect"
                }
            });

            // Wait for all grading (local and AI) to complete
            const results = await Promise.all(gradingPromises);

            let score = 0;
            
            // Now, iterate over the results and update the UI
            results.forEach((result, index) => {
                const question = state.currentTest[index];
                const questionBlock = document.getElementById(`question-block-${index}`);
                
                let isCorrect;
                if (question.type === 'ShortAnswer') {
                    // The result could be a boolean (from simple match) or a string (from AI)
                    isCorrect = (typeof result === 'boolean') ? result : (result.trim().toLowerCase() === 'correct');
                } else {
                    // The result is already a boolean for MCQ/TrueFalse
                    isCorrect = result;
                }

                if (isCorrect) {
                    score++;
                    questionBlock.classList.add('correct');
                    questionBlock.classList.remove('incorrect');
                } else {
                    questionBlock.classList.add('incorrect');
                    questionBlock.classList.remove('correct');
                }
            });

            // Display final score
            const resultsEl = document.getElementById('quiz-results');
            resultsEl.innerHTML = `<h3 class="text-2xl font-bold text-center text-indigo-700">You scored ${score} out of ${state.currentTest.length}!</h3><p class="text-center text-gray-600">Review your answers below.</p>`;
            
            // Update button to "Graded" state
            submitButton.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Graded!`;
            lucide.createIcons(); // Redraw icons in feedback and button
        }

        // --- INITIAL RENDER ---
        render();
    </script>
</body>
</html>
