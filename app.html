<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Learning Genie - Learner Hub</title>
    <link rel="icon" href="/logo.svg" type="image/svg+xml">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/html-to-docx@1.8.0/dist/html-to-docx.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(to bottom, rgb(238 242 255), #f8fafc);
            min-height: 100vh;
        }
        .prose { max-width: 65ch; }
        .prose-sm { font-size: 0.875rem; line-height: 1.5; }
        @media print {
            /* Print styles */
        }
        .genie-logo {
            width: 5rem;
            height: 5rem;
        }
        @media (min-width: 768px) {
            .genie-logo {
                width: 12rem;
                height: 12rem;
            }
        }
        .quiz-question-wrapper.correct {
            border-left-color: #22c55e;
            background-color: #f0fdf4;
        }
        .quiz-question-wrapper.incorrect {
            border-left-color: #ef4444;
            background-color: #fef2f2;
        }
        .quiz-feedback {
            display: none;
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 0.75rem;
        }
        .quiz-question-wrapper.correct .quiz-feedback.correct {
            display: block;
            color: #166534;
        }
        .quiz-question-wrapper.incorrect .quiz-feedback.incorrect {
            display: block;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <div id="app-container" class="min-h-screen">
        <div id="loading-spinner" class="flex items-center justify-center min-h-screen">
             <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600"></div>
        </div>
    </div>

    <script>
        // Wrap all code in a DOMContentLoaded listener to prevent all race conditions.
        document.addEventListener("DOMContentLoaded", () => {
    
            // --- SUPABASE & APP STATE ---
            const SUPABASE_URL = 'https://yvoemqckgtmedfjudkzo.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl2b2VtcWNrZ3RtZWRmanVka3pvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4Mjk3ODYsImV4cCI6MjA3NjQwNTc4Nn0.tbbJT2QWg_Cpl0_FbfVxyZl1Fsord1LQKJztyGQloJo';
            const { createClient } = supabase;
            const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            const state = {
                session: null,
                activeProfile: null,
                activeTab: 'home',
                uploadedImageBase64: null,
                currentTest: null,
                // NEW: State for viewing past work
                workToView: null,
                myActivityData: [] // Caches loaded activity data
            };

            // --- AUTH & ONBOARDING TEMPLATES ---

            const paymentPlaceholderTemplate = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-b from-indigo-50 to-white p-4">
                    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl text-center">
                        <i data-lucide="party-popper" class="h-16 w-16 text-amber-500 mx-auto mb-4"></i>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome to Learning Genie!</h1>
                        <p class="text-gray-600 mb-6">To keep things simple, all features are enabled for free during our launch. No payment required!</p>
                        <button id="skip-payment-btn" class="mt-4 w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">
                            Continue to App
                        </button>
                    </div>
                </div>
            `;

            const createProfileTemplate = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-b from-indigo-50 to-white p-4">
                    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl text-center">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Create Your First Learner Profile</h1>
                        <p class="text-gray-600 mb-6">This will be the first profile on your account (e.g., "Alex" or "Sarah").</p>
                        <form id="create-profile-form">
                            <label for="profile-name" class="block text-sm font-medium text-gray-700 text-left mb-1">Profile Name</label>
                            <input type="text" id="profile-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required placeholder="e.g., Alex">
        .from('accounts')
                        .update({ active_tier: 'free' })
                        .eq('id', state.session.user.id);
                    
                    if (error) console.error('Error updating tier:', error);
                    await checkAccountStatus(state.session.user);
                }
                const profileButton = e.target.closest('.profile-select-btn');
                if (profileButton) {
                    const profileId = profileButton.dataset.profileId;
                    const { data: profile } = await supabaseClient.from('profiles').select('*').eq('id', profileId).single();
                    if (profile) {
                        state.activeProfile = profile;
                        showMainApp();
                    }
                }
                if (e.target.closest('#show-add-profile-btn')) {
                     appContainer.innerHTML = createProfileTemplate;
                     lucide.createIcons();
                }
            });

            // Handle image uploads
            appContainer.addEventListener('change', (e) => {
                if (e.target.id === 'image-upload') handleImageChange(e);
            });
            
            // Handle form submissions
            appContainer.addEventListener('submit', async (e) => {
                e.preventDefault(); 

                // Quiz Submission
                if (e.target.id === 'quiz-form') {
                    await handleQuizSubmit(e.target);
                }

                // Create Profile Form
                if (e.target.id === 'create-profile-form') {
                    const name = document.getElementById('profile-name').value;
                    const button = document.getElementById('create-profile-btn');
                    button.disabled = true;

                    const { error } = await supabaseClient
                        .from('profiles')
                        .insert({ 
                            account_id: state.session.user.id, 
                            name: name 
                        });
                    
                    if (error) {
                        alert(`Error creating profile: ${error.message}`);
                        button.disabled = false;
                    } else {
                        await checkAccountStatus(state.session.user);
                    }
                }
            });

            // --- API & BUSINESS LOGIC ---
            
            async function fetchWithRetry(prompt, isJson, retries = 1, requestType = 'text', imageData = null) {
                try {
                    const response = await fetch('/.netlify/functions/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt, isJson, requestType, imageData })
                    });
                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API request failed with status ${response.status}: ${errorBody}`);
                    }
                    
                    const result = await response.json();

                    if (requestType === 'image') {
                        if (!result.predictions?.[0]?.bytesBase64Encoded) throw new Error("Image generation failed.");
                        return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    }
                    
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("The AI returned an empty response.");
                    return text;
                } catch (error) {
                    if (retries > 0) {
                        console.warn("Request failed, retrying...", error);
                        await new Promise(resolve => setTimeout(resolve, 500));
                        return fetchWithRetry(prompt, isJson, retries - 1, requestType, imageData);
                    }
                    throw error;
                }
            }
            
            // NEW: Function to load "My Activity"
            async function loadMyActivity() {
                const outputEl = document.getElementById('my-activity-output');
                if (!outputEl) return;

                try {
                    const { data, error } = await supabaseClient
                        .from('saved_work')
                        .select('*')
                        .eq('profile_id', state.activeProfile.id)
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        outputEl.innerHTML = `<p class="text-center text-gray-500">No activity found for ${state.activeProfile.name} yet.</p>`;
                        return;
                    }

                    // Cache the data in the state
                    state.myActivityData = data; 
                    
                    const toolIcons = {
                        homeworkHelper: 'life-buoy',
                        learningHub: 'book-marked',
                        explainSimply: 'baby',
                        testBuilder: 'clipboard-check'
                    };

                    outputEl.innerHTML = data.map((item, index) => {
                        const icon = toolIcons[item.tool_type] || 'help-circle';
                        const title = item.input_prompt || `Saved ${item.tool_type} (Image)`;
                        // Format date nicely
                        const date = new Date(item.created_at).toLocaleDateString(undefined, {
                            day: 'numeric',
          .from('accounts')
                        .select('active_tier')
                        .eq('id', user.id)
                        .single();

                    if (accountError && accountError.code !== 'PGRST116') { // PGRST116 = no rows found
                        throw new Error(`Failed to fetch account: ${accountError.message}`);
                    }

                    if (!account || (account.active_tier !== 'free' && !account.active_tier?.startsWith('paid_'))) {
                        // User has no account OR their tier is not active
                        appContainer.innerHTML = paymentPlaceholderTemplate;
                        lucide.createIcons();
                        return;
                    }

                    // 2. User has an active account, check for profiles
                    const { data: profiles, error: profileError } = await supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('account_id', user.id);

                    if (profileError) {
                        throw new Error(`Failed to fetch profiles: ${profileError.message}`);
                    }

                    if (profiles && profiles.length > 0) {
                        // User has profiles, show picker
                        appContainer.innerHTML = profilePickerTemplate(profiles);
                        lucide.createIcons();
                    } else {
                        // User has no profiles, force creation
                        appContainer.innerHTML = createProfileTemplate;
                        lucide.createIcons();
                    }

                } catch (error) {
                    // If anything failed, show a clear error
                    console.error('Error in checkAccountStatus:', error);
                    appContainer.innerHTML = `
                        <div class="min-h-screen flex items-center justify-center p-4">
S ('MCQ');
                if (document.getElementById('tb-qt-tf').checked) questionTypes.push('TrueFalse');
                if (document.getElementById('tb-qt-short').checked) questionTypes.push('ShortAnswer');

                errorEl.classList.add('hidden');
                if (!topic || questionTypes.length === 0) {
                    errorEl.textContent = 'Please provide a topic and select at least one question type.';
                    errorEl.classList.remove('hidden');
                    return;
                }

                button.disabled = true;
S                 button.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Generating...`;
                outputEl.innerHTML = `<div class="text-center text-gray-600"><p>Building your practice test...</p></div>`;
                state.currentTest = null; 

                const prompt = `You are an AI test generator. Create a practice test based on the following parameters.
    Provide a JSON object with a single key: "practice_test".
    - "practice_test": An array of exactly ${numQuestions} question objects. Each object must have three keys:
        1. "question": The string of the question text.
        2. "type": A string, must be one of the selected types: ${questionTypes.join(', ')}. Try to include a mix if multiple types are selected.
S       3. "options": An array of strings for "MCQ" and "TrueFalse" types. Leave empty [] for "ShortAnswer".
        4. "correct_answer": The string of the correct answer. For "MCQ" and "TrueFalse", this must exactly match one of the strings in the "options" array. For "ShortAnswer", this is the expected answer.
    The topic for the test is: ${topic}`;

                try {
                    const jsonText = await fetchWithRetry(prompt, true);
                    const result = JSON.parse(jsonText);
                    
                    // NEW: Save to 'saved_work' table
                    supabaseClient.from('saved_work').insert({
                      Vertical   profile_id: state.activeProfile.id,
                        tool_type: 'testBuilder',
                        input_prompt: topic,
                        output_data: result // Save the full JSON
                    }).then(({ error }) => {
                        if (error) console.error("Error saving work:", error.message);
                    });

                    // ... (rest of the function is unchanged) ...
                    state.currentTest = result.practice_test || [];
                    const quizHtml = renderPracticeTest(state.currentTest);

                    outputEl.innerHTML = `
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                             <h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="clipboard-check" class="text-teal-500"></i><span class="ml-2">Your Custom Test</span></h3>
Vertical                        <p class="text-sm text-gray-600 mb-6">Test your knowledge! Check your answers at the end.</p>
                             <div id="quiz-results" class="mb-6"></div>
                             ${quizHtml}
                  S     </div>
                    `;
                    lucide.createIcons();

                } catch (e) {
                    errorEl.textContent = `An error occurred: ${e.message}`;
                    errorEl.classList.remove('hidden');
                a     outputEl.innerHTML = '<div class="text-center text-red-600"><p>Could not generate test. Please try again.</p></div>';
                } finally {
                    button.disabled = false;
                    button.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5 mr-2"></i>Generate Test`;
                    lucide.createIcons();
                }
            }

            // --- FILE & IMAGE HANDLERS ---
Vertical             // ... (these functions are unchanged) ...
            function handleImageChange(e) {
                const file = e.target.files[0];
                if (!file) return;
                const previewWrapper = document.getElementById('image-preview-wrapper');
                const previewImg = document.getElementById('image-preview');
                const reader = new FileReader();
                reader.onload = (event) => {
                    state.uploadedImageBase64 = event.target.result.split(',')[1];
SR                 previewImg.src = event.target.result;
                    previewWrapper.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }

            function handleRemoveImage() {
                state.uploadedImageBase64 = null;
                document.getElementById('image-preview-wrapper').classList.add('hidden');
                document.getElementById('image-upload').value = null;
            }
S
            // --- UTILITY FUNCTIONS ---
            // ... (these functions are unchanged) ...
            function createSectionHTML(icon, color, title, content) {
                const cleanMarkdown = (text) => {
                    return String(text)
                        .replace(/\*\*\*(.*?)\*\*\*/g, '<hr class="my-4 border-gray-200"><strong><em>$1</em></strong><hr class="my-4 border-gray-200">')
                        .replace(/\*\*/g, '')
                        .replace(/\*/g, '')
                        .replace(/## /g, '<h3 class="text-md font-semibold mt-4">')
S                     .replace(/\n/g, '<br>');
                };

          D   let textContent = 'No content provided.';
                if (typeof content === 'string') {
                    textContent = cleanMarkdown(content);
                } else if (Array.isArray(content)) {
                    textContent = `<ol class="list-decimal list-inside">${content.map(item => `<li>${cleanMarkdown(item)}</li>`).join('')}</ol>`;
s             } else if (typeof content === 'object' && content !== null) {
                    const formatObject = (obj) => {
                        return `<ul class="list-disc list-inside ml-4">${Object.entries(obj).map(([key, value]) => `<li><strong>${key}:</strong> ${formatContent(value)}</li>`).join('')}</ul>`;
                    };
                    const formatArray = (arr) => {
                        return `<ol class="list-decimal list-inside">${arr.map(item => `<li>${formatContent(item)}</li>`).join('')}</ol>`;
                    };
                    const formatContent = (item) => {
                        if (typeof item === 'string') return cleanMarkdown(item);
                        if (Array.isArray(item)) return formatArray(item);
                        if (typeof item === 'object' && item !== null) return formatObject(item);
SR                       return cleanMarkdown(String(item));
                    };
                    textContent = formatContent(content);
    S         } else if (content) {
                    textContent = cleanMarkdown(String(content));
                }
                return `<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 break-inside-avoid"><h3 class="text-lg font-semibold text-gray-800 flex items-center mb-3"><i data-lucide="${icon}" class="text-${color}-500"></i><span class="ml-2">${title}</span></h3><div classD="prose prose-sm max-w-none text-gray-600">${textContent}</div></div>`;
            }
            
            function renderPracticeTest(testData) {
                if (!testData || testData.length === 0) {
                    return "<p class='text-sm text-gray-500'>No practice test could be generated for this topic.</p>";
                }

                let html = '<form id="quiz-form" class="space-y-6">';
                
                testData.forEach((question, index) => {
                    html += `<div id="question-block-${index}" class="quiz-question-wrapper border-l-4 border-gray-200 p-4 rounded-r-lg">`;
S                   html += `<p class="font-semibold text-gray-800 mb-3">${index + 1}. ${question.question}</p>`;
                    html += `<div class="space-y-2">`;

                    if (question.type === 'MCQ' || question.type === 'TrueFalse') {
                        question.options.forEach((option) => {
          SR                 html += `
                                <label class="flex items-center p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="question_${index}" value="${option}" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                    <span class="ml-3 text-sm text-gray-700">${option}</span>
s                               </label>
                            `;
                        });
                    } else if (question.type === 'ShortAnswer') {
                        html += `
                            <label>
S                             <span class="text-sm font-medium text-gray-700 sr-only">Your Answer:</span>
                                <input type="text" name="question_${index}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Type your answer here...">
                            </label>
                        `;
                    }
                    html += `</div>`;
S                   html += `
                        <div class="quiz-feedback correct">
                            <i data-lucide="check-circle" class="inline-block h-4 w-4 mr-1"></i>Correct!
                        </div>
                        <div class="quiz-feedback incorrect">
s                         <i data-lucide="x-circle" class="inline-block h-4 w-4 mr-1"></i>Incorrect. The correct answer is: <strong>${question.correct_answer}</strong>
                        </div>
                    `;
                    html += `</div>`;
                });

                html += `<button id="submit-quiz-btn" type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center disabled:bg-green-300"><i data-lucide="check" class="w-5 h-5 mr-2"></i>Check My Answers</button>`;
                html += '</form>';
                return html;
            }

            async function handleQuizSubmit(formElement) {
                // ... (this function is unchanged) ...
                if (!state.currentTest) return;

                const formData = new FormData(formElement);
                const submitButton = formElement.querySelector('button[type="submit"]');

                submitButton.disabled = true;
                submitButton.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-3"></div> Grading...`;
S               formElement.querySelectorAll('input').forEach(input => input.disabled = true);
                
                const gradingPromises = state.currentTest.map((question, index) => {
                    const userAnswer = formData.get(`question_${index}`);
                    const correctAnswer = question.correct_answer;

                    if (!userAnswer) {
                        return Promise.resolve(false);
s                 }

                    if (question.type === 'MCQ' || question.type === 'TrueFalse') {
                        return Promise.resolve(userAnswer === correctAnswer);
                    } 
                    
              S     if (question.type === 'ShortAnswer') {
                        if (userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase()) {
                            return Promise.resolve(true);
                        }
                      D const prompt = `You are an AI grader. A student was asked the following question: "${question.question}". The model answer is: "${correctAnswer}". The student provided this answer: "${userAnswer}". Is the student's answer substantially correct? Your response must be a single word: "Correct" or "Incorrect".`;
                        return fetchWithRetry(prompt, false);
                    }
                });

s             const results = await Promise.all(gradingPromises);

                let score = 0;
      S         
                results.forEach((result, index) => {
                    const question = state.currentTest[index];
                    const questionBlock = document.getElementById(`question-block-${index}`);
                    
                    let isCorrect;
SR                   if (question.type === 'ShortAnswer') {
                        isCorrect = (typeof result === 'boolean') ? result : (result.trim().toLowerCase() === 'correct');
                    } else {
                    s   isCorrect = result;
                    }

                    if (isCorrect) {
                        score++;
                        questionBlock.classList.add('correct');
S                       questionBlock.classList.remove('incorrect');
          D         } else {
                        questionBlock.classList.add('incorrect');
                        questionBlock.classList.remove('correct');
                    }
                });

    s           const resultsEl = document.getElementById('quiz-results');
                resultsEl.innerHTML = `<h3 class="text-2xl font-bold text-center text-indigo-700">You scored ${score} out of ${state.currentTest.length}!</h3><p class="text-center text-gray-600">Review your answers below.</p>`;
                
                submitButton.innerHTML = `<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Graded!`;
Show             lucide.createIcons();
            }

        S   // --- INITIAL RENDER ---
            handleAuth(); // Start the auth flow on page load

        }); // --- END OF THE DOMContentLoaded WRAPPER ---
    </script>
    
    <div id="cookie-consent-banner" class="hidden fixed bottom-0 left-0 right-0 bg-gray-900 text-white p-4 shadow-lg z-50 flex-col md:flex-row justify-between items-center">
S s     <p class="text-sm mb-2 md:mb-0 md:mr-4">
            We use essential cookies to make our site work. By using our site, you consent to our use of cookies.
            <a href="/legal.html#cookies" class="font-semibold underline hover:text-indigo-300">Learn More</a>.
        </p>
        <button id="accept-cookies-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 flex-shrink-0">
S           Accept
        </button>
    </div>
    <script>
        (function() {
            const banner = document.getElementById('cookie-consent-banner');
            const acceptBtn = document.getElementById('accept-cookies-btn');
            if (localStorage.getItem('cookie_consent') === 'true') {
                return;
    PCA       }
            banner.classList.remove('hidden');
            banner.classList.add('flex');
            acceptBtn.addEventListener('click', () => {
                localStorage.setItem('cookie_consent', 'true');
                banner.style.display = 'none';
            });
        })();
    </script>
</body>
</html>
